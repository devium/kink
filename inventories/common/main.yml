stage: "{{ lookup('env', 'ANSIBLE_STAGE') }}"
stage_prefix: "{{ '' if stage == 'prod' else stage + '-' }}"
helm_release_name: "main"
namespace_prefix: "{{ stage_prefix }}"
secrets_file: "{{ ansible_inventory_sources[0] | dirname }}/group_vars/all/secrets.yml"

app_config_default:
  buddy:
    subdomain: buddy

  collabora:
    subdomain: office.next

  element:
    subdomain: element

  grafana:
    subdomain: grafana

  hedgedoc:
    subdomain: doc

  home:
    subdomain: www

  jitsi:
    subdomain: jitsi

  keycloak:
    subdomain: auth

  mailserver:
    subdomain: mail

  minecraft:
    subdomain: minecraft

  nextcloud:
    subdomain: next

  pretix:
    subdomain: tickets

  shlink:
    subdomain: api.shlink

  shlink_web:
    subdomain: shlink

  sliding_sync:
    subdomain: syncv3

  synapse:
    subdomain: matrix

app_config: "{{ app_config_default | combine(app_config_override, recursive=True) }}"
# Apps with subdomain attribute:
subdomain_app_config_items: "{{ app_config | dict2items | selectattr('value.subdomain', 'defined') }}"
# App dict keys:
subdomain_app_config_keys: "{{ subdomain_app_config_items | map(attribute='key') }}"
# App subdomains:
subdomain_app_config_subdomains: "{{ subdomain_app_config_items | map(attribute='value.subdomain') }}"
# Zip of keys and subdomains:
subdomains: "{{ dict(subdomain_app_config_keys | zip(subdomain_app_config_subdomains)) }}"


mail_domain: "{{ domain }}"
mail_mail_aliases: "{{ mail_aliases }}"
mail_mail_accounts: "{{ mail_accounts }}"
mail_stage: "{{ stage }}"


terraform_servers_backend: "{{ terraform_backend }}"
terraform_servers_domain: "{{ domain }}"
terraform_servers_hcloud_token: "{{ hcloud_token }}"
terraform_servers_hdns_token: "{{ hdns_token }}"
terraform_servers_hdns_zone_id: "{{ hdns_zone_id }}"
terraform_servers_ssh_key: "{{ ssh_key }}"
terraform_servers_stage: "{{ stage }}"
terraform_servers_subdomains: "{{ subdomains }}"

terraform_servers_nodes:
  - name: master
    type: cx21
    image: ubuntu-22.04
    taints: "[CriticalAddonsOnly=true:NoSchedule]"
  - name: worker0
    type: cx21
    image: ubuntu-22.04
    taints: "[]"
  - name: worker1
    type: cx21
    image: ubuntu-22.04
    taints: "[]"
  - name: worker2
    type: cx21
    image: ubuntu-22.04
    taints: "[]"
  - name: worker3
    type: cx21
    image: ubuntu-22.04
    taints: "[]"
  - name: gaming
    type: cpx31
    image: ubuntu-22.04
    taints: "[CriticalAddonsOnly=true:NoSchedule]"


netplan_config_file: /etc/netplan/60-floating-ip.yaml
netplan_remove_existing: false

netplan_configuration:
  network:
   version: 2
   renderer: networkd
   ethernets:
     eth0:
       addresses:
       - "{{ ansible_host }}/32"
       - "{{ ipv6_address }}/64"


rke2_download_kubeconf: true
rke2_download_kubeconf_file_name: rke2.yaml
rke2_download_kubeconf_path: "{{ ansible_inventory_sources[0] | dirname }}"
rke2_version: v1.28.3+rke2r2


terraform_cluster_backend: "{{ terraform_backend }}"
terraform_cluster_app_config_override: "{{ app_config }}"
terraform_cluster_domain: "{{ domain }}"
terraform_cluster_kubeconf_file: "{{ rke2_download_kubeconf_path }}/{{ rke2_download_kubeconf_file_name }}"
terraform_cluster_stage: "{{ stage }}"


config_kubeconf_file: "{{ rke2_download_kubeconf_path }}/{{ rke2_download_kubeconf_file_name }}"
config_domain: "{{ domain }}"
config_subdomains_override: "{{ subdomains_override }}"
config_namespaces_override: "{{ namespaces }}"
config_keycloak_realm: "{{ project_name }}"
config_keycloak_secrets: "{{ keycloak_secrets }}"
config_admin_passwords: "{{ admin_passwords }}"
config_db_passwords: "{{ db_passwords }}"
config_helm_release_name: "{{ helm_release_name }}"
